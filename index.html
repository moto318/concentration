<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple English Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans">

    <nav class="bg-white p-4 shadow flex justify-between items-center z-10">
        <h1 class="font-bold text-xl text-blue-600">English Game (Simple)</h1>
        <div id="status" class="text-xs bg-gray-200 px-2 py-1 rounded">Offline</div>
    </nav>

    <main class="flex-1 overflow-hidden relative">
        
        <div id="sceneLogin" class="absolute inset-0 bg-gray-100 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md space-y-4">
                <h2 class="text-2xl font-bold text-center mb-4">Login</h2>
                <input type="text" id="inputName" class="w-full border p-3 rounded" placeholder="Your Name (名前)">
                <input type="text" id="inputRoom" class="w-full border p-3 rounded" placeholder="Room ID (部屋名)">
                <button onclick="joinGame()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700">
                    Join Room
                </button>
            </div>
        </div>

        <div id="sceneGame" class="hidden absolute inset-0 flex flex-col p-4 overflow-y-auto">
            
            <div class="flex justify-between items-center mb-4 bg-white p-3 rounded shadow">
                <div>
                    <span class="text-gray-500 text-xs">Turn:</span>
                    <span id="displayTurn" class="font-bold text-lg text-blue-600">--</span>
                </div>
                <div id="hostControls" class="hidden flex gap-2">
                    <button onclick="resetGame()" class="bg-red-500 text-white text-xs px-3 py-1 rounded hover:bg-red-600">Reset Game</button>
                </div>
            </div>

            <div id="playerList" class="flex gap-2 mb-4 flex-wrap"></div>

            <div id="hostSettings" class="hidden bg-yellow-50 p-4 rounded border border-yellow-200 mb-4">
                <h3 class="font-bold text-sm mb-2">Teacher Settings</h3>
                <textarea id="wordInput" class="w-full h-24 text-xs p-2 border rounded mb-2" placeholder="English [TAB] Japanese"></textarea>
                <button onclick="startGame()" class="w-full bg-green-600 text-white font-bold py-2 rounded">START GAME</button>
            </div>

            <div id="waitingMsg" class="hidden text-center text-gray-500 mt-10 text-xl animate-pulse">
                Waiting for teacher to start...
            </div>

            <div id="gameGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-3 pb-10"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // YOUR CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyBE5uUhcvyGU_t6dOuMbUeZYpDB813uPhs",
          authDomain: "concentration-2cb8a.firebaseapp.com",
          projectId: "concentration-2cb8a",
          storageBucket: "concentration-2cb8a.firebasestorage.app",
          messagingSenderId: "1034581366776",
          appId: "1:1034581366776:web:e46d84210c3eacba3ae80d",
          measurementId: "G-D3GC22P1P5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // VARIABLES
        let myId = "u_" + Math.random().toString(36).substr(2, 9);
        let myName = "";
        let roomId = "";
        let localData = null;

        // --- FUNCTIONS ---

        window.joinGame = async () => {
            myName = document.getElementById('inputName').value.trim();
            roomId = document.getElementById('inputRoom').value.trim();
            if(!myName || !roomId) return alert("名前と部屋名を入力してください");

            // UI SWITCH
            document.getElementById('sceneLogin').classList.add('hidden');
            document.getElementById('sceneGame').classList.remove('hidden');
            document.getElementById('status').textContent = "Connecting...";

            const roomRef = doc(db, "rooms", roomId);
            
            try {
                const snap = await getDoc(roomRef);
                const me = { id: myId, name: myName, score: 0 };

                if (!snap.exists()) {
                    // Create Room
                    await setDoc(roomRef, {
                        hostId: myId,
                        players: [me],
                        status: 'lobby',
                        cards: [],
                        turnIndex: 0,
                        flipped: []
                    });
                } else {
                    // Join Room
                    await updateDoc(roomRef, {
                        players: arrayUnion(me)
                    });
                }

                // LISTEN
                onSnapshot(roomRef, (doc) => {
                    if(!doc.exists()) { alert("Room Reset"); location.reload(); return; }
                    localData = doc.data();
                    render(localData);
                    document.getElementById('status').textContent = "Online: " + roomId;
                });

            } catch(e) {
                alert("Error: " + e.message);
                location.reload();
            }
        };

        window.startGame = async () => {
            const text = document.getElementById('wordInput').value;
            const lines = text.trim().split('\n');
            let cards = [];
            let pid = 0;

            lines.forEach(l => {
                let [a,b] = l.split(/,|\t/); // Split by comma or tab
                if(a && b) {
                    cards.push({ id:0, pid:pid, text:a.trim(), open:false, matched:false });
                    cards.push({ id:0, pid:pid, text:b.trim(), open:false, matched:false });
                    pid++;
                }
            });

            if(cards.length < 4) return alert("Words not enough (need 2+ pairs)");

            // Shuffle
            cards.sort(() => Math.random() - 0.5);
            cards.forEach((c,i) => c.id = i);

            await updateDoc(doc(db, "rooms", roomId), {
                cards: cards,
                status: 'playing',
                turnIndex: 0,
                flipped: []
            });
        };

        window.resetGame = async () => {
            if(!confirm("Reset?")) return;
            // Simply clear cards and go back to lobby. Keep players.
            await updateDoc(doc(db, "rooms", roomId), {
                status: 'lobby',
                cards: [],
                flipped: [],
                turnIndex: 0
            });
        };

        window.cardClick = async (idx) => {
            if(!localData) return;
            const d = localData;
            
            // Checks
            if(d.status !== 'playing') return;
            if(d.players[d.turnIndex].id !== myId) return; // Not my turn
            if(d.flipped.length >= 2) return; // Already 2 flipped
            if(d.cards[idx].open || d.cards[idx].matched) return; // Already open

            // Open Card
            let newCards = [...d.cards];
            newCards[idx].open = true;
            let newFlipped = [...d.flipped, idx];

            await updateDoc(doc(db, "rooms", roomId), {
                cards: newCards,
                flipped: newFlipped
            });

            // Match Logic
            if(newFlipped.length === 2) {
                setTimeout(async () => {
                    const c1 = newCards[newFlipped[0]];
                    const c2 = newCards[newFlipped[1]];
                    let updates = {};

                    if(c1.pid === c2.pid) {
                        // Match
                        newCards[newFlipped[0]].matched = true;
                        newCards[newFlipped[1]].matched = true;
                        let newPlayers = [...d.players];
                        newPlayers[d.turnIndex].score++;
                        updates = { cards: newCards, players: newPlayers, flipped: [] };
                    } else {
                        // No Match
                        newCards[newFlipped[0]].open = false;
                        newCards[newFlipped[1]].open = false;
                        let nextTurn = (d.turnIndex + 1) % d.players.length;
                        updates = { cards: newCards, flipped: [], turnIndex: nextTurn };
                    }
                    await updateDoc(doc(db, "rooms", roomId), updates);
                }, 1500);
            }
        };

        // --- RENDER ---
        function render(d) {
            const isHost = (d.hostId === myId);
            
            // 1. Controls
            if(isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                if(d.status === 'lobby') {
                    document.getElementById('hostSettings').classList.remove('hidden');
                } else {
                    document.getElementById('hostSettings').classList.add('hidden');
                }
            } else {
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('hostSettings').classList.add('hidden');
            }

            // 2. Waiting Message
            if(d.status === 'lobby' && !isHost) {
                document.getElementById('waitingMsg').classList.remove('hidden');
            } else {
                document.getElementById('waitingMsg').classList.add('hidden');
            }

            // 3. Turn Indicator
            const currentPlayer = d.players[d.turnIndex];
            if(currentPlayer) {
                const isMe = currentPlayer.id === myId;
                document.getElementById('displayTurn').textContent = currentPlayer.name + (isMe ? " (YOU)" : "");
                document.getElementById('displayTurn').className = isMe ? "font-bold text-lg text-green-600" : "font-bold text-lg text-gray-600";
            }

            // 4. Players
            const pList = document.getElementById('playerList');
            pList.innerHTML = d.players.map((p, i) => 
                `<div class="px-2 py-1 rounded border ${i===d.turnIndex ? 'bg-blue-100 border-blue-500' : 'bg-white'} text-sm">
                    ${p.name}: ${p.score}pt
                </div>`
            ).join('');

            // 5. Grid
            const grid = document.getElementById('gameGrid');
            if(d.status === 'lobby') {
                grid.innerHTML = '';
            } else {
                grid.innerHTML = d.cards.map((c, i) => `
                    <div onclick="window.cardClick(${i})" 
                         class="aspect-[4/3] rounded-lg cursor-pointer transition-all duration-300 transform shadow-md flex items-center justify-center p-2 text-center font-bold text-sm select-none
                         ${c.open || c.matched ? 'bg-white border-2 border-blue-500 rotate-y-180' : 'bg-blue-600 text-white'}">
                        ${c.open || c.matched ? c.text : (i+1)}
                    </div>
                `).join('');
            }
        }

        // Default Words
        document.getElementById('wordInput').value = `Apple\tりんご
Dog\tいぬ
Cat\tねこ
Book\tほん`;
    </script>
</body>
</html>
