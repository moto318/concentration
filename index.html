<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Game Final Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: sans-serif; background: #f3f4f6; }
        .card { perspective: 1000px; aspect-ratio: 4/3; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .card-inner { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 8px; padding: 4px; border: 2px solid #ccc; font-weight: bold; }
        .front { background: #3b82f6; color: white; font-size: 24px; }
        .back { background: white; color: black; transform: rotateY(180deg); font-size: 14px; }
        .matched .front { background: #10b981; border-color: #10b981; } 
        .active-turn { border: 4px solid #f59e0b; background: #fef3c7; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded shadow-lg w-full max-w-sm space-y-4">
            <h2 class="text-2xl font-bold text-center">Login</h2>
            <div>
                <label class="block text-xs font-bold text-gray-500">NAME</label>
                <input type="text" id="myName" class="w-full border p-2 rounded" placeholder="Taro">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500">ROOM ID</label>
                <input type="text" id="myRoom" class="w-full border p-2 rounded" placeholder="1-1">
            </div>
            
            <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="isTeacher" class="w-5 h-5">
                    <span class="font-bold text-sm">私は先生です (設定・リセット権限)</span>
                </label>
            </div>

            <button onclick="join()" class="w-full bg-blue-600 text-white font-bold py-3 rounded">JOIN ROOM</button>
        </div>
    </div>

    <div id="mainScreen" class="hidden flex-1 flex flex-col">
        <div class="bg-white p-3 shadow flex justify-between items-center">
            <h1 class="font-bold text-gray-700">Room: <span id="dispRoom"></span></h1>
            
            <div id="teacherControls" class="hidden flex gap-2">
                <button onclick="resetRoom()" class="bg-red-600 text-white text-xs px-4 py-2 rounded font-bold">
                    全員キック＆リセット
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            
            <div id="settingsPanel" class="hidden bg-white p-4 rounded shadow mb-4 border-l-4 border-yellow-400">
                <h3 class="font-bold mb-2">単語設定 (English [TAB] Japanese)</h3>
                <textarea id="wordList" class="w-full h-32 border p-2 text-sm font-mono mb-2 bg-gray-50"></textarea>
                <button onclick="startGame()" class="w-full bg-green-600 text-white font-bold py-2 rounded">
                    設定を保存してゲーム開始！
                </button>
            </div>

            <div id="statusMsg" class="text-center py-10 text-xl text-gray-500 hidden">
                先生が準備中です...
            </div>

            <div id="gameInfo" class="hidden mb-4 text-center">
                Turn: <span id="turnName" class="font-bold text-xl text-blue-600">--</span>
            </div>

            <div id="grid" class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-w-4xl mx-auto"></div>
            
            <div id="playerList" class="mt-8 flex flex-wrap gap-2 justify-center"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBE5uUhcvyGU_t6dOuMbUeZYpDB813uPhs",
            authDomain: "concentration-2cb8a.firebaseapp.com",
            projectId: "concentration-2cb8a",
            storageBucket: "concentration-2cb8a.firebasestorage.app",
            messagingSenderId: "1034581366776",
            appId: "1:1034581366776:web:e46d84210c3eacba3ae80d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // VARS
        let myId = "u_" + Date.now();
        let name = "", room = "";
        let amITeacher = false;
        let currentData = null;

        // --- ACTIONS ---

        async function join() {
            name = document.getElementById('myName').value.trim();
            room = document.getElementById('myRoom').value.trim();
            amITeacher = document.getElementById('isTeacher').checked;

            if(!name || !room) return alert("名前と部屋名を入力してください");

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('dispRoom').textContent = room;

            const roomRef = db.collection('rooms').doc(room);
            const me = { id: myId, name: name, score: 0 };

            try {
                // Room Check
                const docSnap = await roomRef.get();
                
                if (!docSnap.exists) {
                    // Create New Room
                    await roomRef.set({
                        hostId: amITeacher ? myId : null,
                        players: [me],
                        status: 'lobby',
                        cards: [],
                        turn: 0,
                        flipped: []
                    });
                } else {
                    // Join Existing
                    const data = docSnap.data();
                    let updates = {
                        players: firebase.firestore.FieldValue.arrayUnion(me)
                    };
                    // ★強制乗っ取りロジック★
                    // 「私は先生です」にチェックが入っていれば、強制的にホストIDを自分にする
                    if (amITeacher) {
                        updates.hostId = myId;
                        updates.status = 'lobby'; // 先生が来たら一旦ロビーに戻す（設定するため）
                    }
                    await roomRef.update(updates);
                }

                // LISTEN
                roomRef.onSnapshot(snap => {
                    if(!snap.exists) { alert("部屋が削除されました"); location.reload(); return; }
                    const d = snap.data();
                    currentData = d;
                    
                    // 自分が消されていたらリロード（キック対応）
                    if(!d.players.find(p => p.id === myId)) {
                        alert("退出させられました");
                        location.reload();
                        return;
                    }

                    render(d);
                });

            } catch(e) {
                alert("エラー: " + e.message);
                location.reload();
            }
        }

        async function resetRoom() {
            if(!confirm("本当に全員をキックしてリセットしますか？")) return;
            // 自分だけ残してリセット
            const me = { id: myId, name: name, score: 0 };
            await db.collection('rooms').doc(room).set({
                hostId: myId,
                players: [me],
                status: 'lobby',
                cards: [],
                turn: 0,
                flipped: []
            });
        }

        async function startGame() {
            const text = document.getElementById('wordList').value;
            const lines = text.trim().split('\n');
            let cards = [];
            let pid = 0;
            
            lines.forEach(line => {
                let [a, b] = line.split(/,|\t/);
                if(a && b) {
                    cards.push({ id:0, pid:pid, text:a.trim(), open:false, matched:false });
                    cards.push({ id:0, pid:pid, text:b.trim(), open:false, matched:false });
                    pid++;
                }
            });

            if(cards.length < 4) return alert("ペアが少なすぎます（2ペア以上必要）");

            // Shuffle
            cards.sort(() => Math.random() - 0.5);
            cards.forEach((c, i) => c.id = i);

            await db.collection('rooms').doc(room).update({
                cards: cards,
                status: 'playing',
                turn: 0,
                flipped: []
            });
        }

        async function cardClick(idx) {
            const d = currentData;
            // ルール判定
            if(d.status !== 'playing') return;
            if(d.players[d.turn].id !== myId) return; // 俺のターンじゃない
            if(d.flipped.length >= 2) return; 
            if(d.cards[idx].open || d.cards[idx].matched) return;

            // オープン処理
            let newCards = [...d.cards];
            newCards[idx].open = true;
            let newFlipped = [...d.flipped, idx];

            await db.collection('rooms').doc(room).update({
                cards: newCards,
                flipped: newFlipped
            });

            // 2枚めくったら判定
            if(newFlipped.length === 2) {
                setTimeout(async () => {
                    const i1 = newFlipped[0];
                    const i2 = newFlipped[1];
                    const c1 = newCards[i1];
                    const c2 = newCards[i2];
                    
                    let updates = {};

                    if(c1.pid === c2.pid) {
                        // 正解
                        newCards[i1].matched = true;
                        newCards[i2].matched = true;
                        let ps = [...d.players];
                        ps[d.turn].score++;
                        updates = { cards: newCards, players: ps, flipped: [] };
                    } else {
                        // 不正解
                        newCards[i1].open = false;
                        newCards[i2].open = false;
                        let next = (d.turn + 1) % d.players.length;
                        updates = { cards: newCards, flipped: [], turn: next };
                    }
                    await db.collection('rooms').doc(room).update(updates);
                }, 1500);
            }
        }

        // --- RENDER ---
        function render(d) {
            const isHost = (d.hostId === myId);

            // 1. Controls (先生だけに見える)
            if(isHost) {
                document.getElementById('teacherControls').classList.remove('hidden');
                // ロビーなら設定パネルを出す
                if(d.status === 'lobby') {
                    document.getElementById('settingsPanel').classList.remove('hidden');
                } else {
                    document.getElementById('settingsPanel').classList.add('hidden');
                }
            } else {
                document.getElementById('teacherControls').classList.add('hidden');
                document.getElementById('settingsPanel').classList.add('hidden');
            }

            // 2. Main View Switch
            const grid = document.getElementById('grid');
            const statusMsg = document.getElementById('statusMsg');
            const gameInfo = document.getElementById('gameInfo');

            if(d.status === 'lobby') {
                grid.innerHTML = '';
                gameInfo.classList.add('hidden');
                if(!isHost) {
                    statusMsg.classList.remove('hidden');
                    statusMsg.textContent = "先生が単語を設定中です...";
                } else {
                    statusMsg.classList.add('hidden');
                }
            } else {
                statusMsg.classList.add('hidden');
                gameInfo.classList.remove('hidden');
                
                // Turn Indicator
                const p = d.players[d.turn];
                const isMe = (p.id === myId);
                const turnName = document.getElementById('turnName');
                turnName.textContent = p.name + (isMe ? " (あなた)" : "");
                turnName.style.color = isMe ? "red" : "blue";

                // Draw Grid
                grid.innerHTML = d.cards.map((c, i) => `
                    <div class="card ${c.matched ? 'matched' : ''} ${c.open ? 'flipped' : ''}" onclick="cardClick(${i})">
                        <div class="card-inner">
                            <div class="front">${i+1}</div>
                            <div class="back">${c.text}</div>
                        </div>
                    </div>
                `).join('');
            }

            // 3. Player List
            document.getElementById('playerList').innerHTML = d.players.map((p, i) => `
                <div class="px-3 py-1 rounded bg-white shadow border ${i===d.turn && d.status==='playing' ? 'active-turn' : ''}">
                    ${p.name}: <b>${p.score}</b>
                </div>
            `).join('');
        }

        // 初期単語
        document.getElementById('wordList').value = "Apple\tりんご\nDog\tいぬ\nCat\tねこ\nBook\tほん";
    </script>
</body>
</html>
