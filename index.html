<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Concentration Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto:wght@400;700&display=swap');
        body { font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: #f0f4f8; user-select: none; }
        .card-container { perspective: 1000px; aspect-ratio: 4 / 3; width: 100%; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card-container.flipped .card-inner, .card-container.matched .card-inner, .card-container.matched-visible .card-inner { transform: rotateY(180deg); }
        .card-container.matched-visible .card-inner { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.5); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.75rem; padding: 1rem; }
        .card-front { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 2rem; }
        .card-back { background-color: white; color: #1f2937; transform: rotateY(180deg); border: 3px solid #3b82f6; overflow: hidden; }
        .active-player { border-left: 6px solid #3b82f6; background-color: #eff6ff; transform: scale(1.02); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50">

    <div id="debugLog" class="fixed bottom-0 right-0 w-64 h-32 bg-black bg-opacity-80 text-green-400 text-xs p-2 overflow-y-auto z-50 pointer-events-none font-mono">
        System Ready...
    </div>

    <nav class="bg-white shadow-sm border-b p-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-2">
            <i data-lucide="globe" class="text-blue-600"></i>
            <h1 class="font-bold text-gray-800">English Online (Final)</h1>
        </div>
        <div class="flex gap-2 items-center">
            <button id="adminResetBtn" onclick="forceResetRoom()" class="hidden bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded shadow animate-pulse">
                RESET
            </button>
            <div id="connectionStatus" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">Wait...</div>
        </div>
    </nav>

    <main class="flex-1 relative overflow-hidden">
        
        <div id="sceneSetup" class="absolute inset-0 bg-slate-100 z-50 flex items-center justify-center p-4">
            <div class="bg-white max-w-md w-full rounded-xl shadow-xl p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-800">Game Login</h2>
                <div class="space-y-4">
                    <input type="text" id="playerName" class="w-full border rounded p-3" placeholder="Name (Ex: Taro)">
                    <input type="text" id="roomName" class="w-full border rounded p-3" placeholder="Room ID (Ex: 1-1)">
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="isTeacherMode" class="w-5 h-5 text-blue-600">
                            <span class="text-sm font-bold text-gray-800">I am the Teacher</span>
                        </label>
                    </div>
                </div>
                <button onclick="startApp()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700">Enter Room</button>
            </div>
        </div>

        <div id="sceneAdmin" class="hidden absolute inset-0 bg-slate-50 z-40 p-4 overflow-y-auto">
            <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow border space-y-6">
                <h2 class="text-2xl font-bold">Teacher Dashboard</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold border-b pb-2 mb-2">Card Settings</h3>
                        <textarea id="gameWordsInput" class="w-full h-32 border rounded p-2 text-sm font-mono" placeholder="English [TAB] Japanese"></textarea>
                        <div class="mt-2 flex gap-2">
                             <input type="checkbox" id="hostParticipates"> <label for="hostParticipates" class="text-sm">Participate in game</label>
                        </div>
                        <button onclick="saveGameSettings()" class="w-full bg-green-600 text-white font-bold py-2 mt-4 rounded">Update Cards & Ready</button>
                    </div>
                    <div>
                        <div class="flex justify-between border-b pb-2 mb-2">
                            <h3 class="font-bold">Students</h3>
                            <button onclick="forceResetRoom()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Kick All</button>
                        </div>
                        <div id="adminPlayerList" class="bg-gray-100 h-32 overflow-y-auto p-2 text-sm"></div>
                        <button onclick="switchScene('game')" class="w-full bg-indigo-600 text-white font-bold py-2 mt-4 rounded">Go to Game View</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sceneLobby" class="hidden absolute inset-0 bg-white z-40 flex flex-col items-center justify-center p-4">
            <h2 class="text-3xl font-bold mb-4">Room: <span id="lobbyRoomName" class="text-blue-600"></span></h2>
            <div id="lobbyPlayerList" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
            <div id="commonStartArea" class="hidden">
                <button onclick="startGame()" class="bg-indigo-600 text-white text-xl font-bold py-4 px-8 rounded shadow animate-bounce">GAME START!</button>
            </div>
            <div id="waitingMessage" class="text-gray-400 italic">Waiting for teacher...</div>
        </div>

        <div id="sceneGame" class="hidden h-full flex flex-col md:flex-row bg-slate-100">
             <div class="w-full md:w-64 bg-white border-r p-4">
                <div class="mb-4">
                    <div class="text-xs font-bold text-gray-400 uppercase">Turn</div>
                    <div id="gameTurnIndicator" class="text-xl font-bold text-blue-600 p-2 bg-blue-50 rounded">--</div>
                </div>
                <div id="gameScoreBoard" class="space-y-2"></div>
                <button onclick="switchScene('admin')" id="backToAdminBtn" class="hidden w-full mt-8 bg-gray-200 text-gray-700 py-2 rounded">Back to Admin</button>
             </div>
             <div class="flex-1 p-4 overflow-y-auto">
                <div id="gameGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-4 max-w-7xl mx-auto pb-20"></div>
             </div>
        </div>
    </main>

    <script>
        // --- LOGGING ---
        function log(msg) {
            const el = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div>[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }
        window.onerror = function(msg) { log("ERROR: " + msg); };

        // --- CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBE5uUhcvyGU_t6dOuMbUeZYpDB813uPhs",
          authDomain: "concentration-2cb8a.firebaseapp.com",
          projectId: "concentration-2cb8a",
          storageBucket: "concentration-2cb8a.firebasestorage.app",
          messagingSenderId: "1034581366776",
          appId: "1:1034581366776:web:e46d84210c3eacba3ae80d",
          measurementId: "G-D3GC22P1P5"
        };

        // --- INITIALIZE FIREBASE (CLASSIC) ---
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            log("Firebase Initialized (Compat Mode)");
            document.getElementById('connectionStatus').textContent = "Ready";
        } catch(e) {
            log("INIT ERROR: " + e.message);
        }

        // --- STATE ---
        let myName = "", myRoom = "", myId = "", isHost = false, localData = null;
        
        // Persistent ID
        if(localStorage.getItem('pid')) myId = localStorage.getItem('pid');
        else { myId = "u_" + Date.now(); localStorage.setItem('pid', myId); }

        // --- SCENE MGR ---
        function switchScene(name) {
            ['sceneSetup','sceneAdmin','sceneLobby','sceneGame'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('scene'+name.charAt(0).toUpperCase() + name.slice(1)).classList.remove('hidden');
            
            // UI Updates based on scene
            if(name === 'admin' && localData) renderAdmin(localData);
        }

        // --- ACTIONS ---
        function startApp() {
            myName = document.getElementById('playerName').value.trim();
            myRoom = document.getElementById('roomName').value.trim();
            isHost = document.getElementById('isTeacherMode').checked;

            if(!myName || !myRoom) { alert("Please enter Name and Room."); return; }
            
            localStorage.setItem('pname', myName);
            localStorage.setItem('proom', myRoom);
            
            log(`Joining ${myRoom} as ${myName} (Host:${isHost})`);
            joinRoom();
        }

        function joinRoom() {
            const docRef = db.collection('rooms').doc(myRoom);
            
            docRef.get().then((doc) => {
                const me = { id: myId, name: myName, score: 0, isSpectator: isHost };

                if(!doc.exists) {
                    // Create Room
                    docRef.set({
                        status: 'lobby',
                        players: [me],
                        hostId: isHost ? myId : null,
                        cards: [],
                        setupComplete: false,
                        turnIndex: 0,
                        flipped: []
                    }).then(() => log("Room Created"));
                } else {
                    // Join Room
                    const data = doc.data();
                    let update = {};
                    
                    // Host takeover
                    if(isHost && data.hostId !== myId) update.hostId = myId;
                    
                    // Add/Update Player
                    const pExists = data.players.find(p => p.id === myId);
                    if(pExists) {
                        // Update name if changed
                        if(pExists.name !== myName) {
                            const newP = data.players.map(p => p.id === myId ? {...p, name: myName} : p);
                            update.players = newP;
                        }
                    } else {
                        update.players = firebase.firestore.FieldValue.arrayUnion(me);
                    }

                    if(Object.keys(update).length > 0) docRef.update(update);
                }

                // Initial Scene
                if(isHost) {
                    switchScene('admin');
                    document.getElementById('adminResetBtn').classList.remove('hidden');
                    document.getElementById('backToAdminBtn').classList.remove('hidden');
                } else {
                    switchScene('lobby');
                }
                document.getElementById('lobbyRoomName').textContent = myRoom;
                document.getElementById('adminRoomName').textContent = myRoom;

                // Listen
                docRef.onSnapshot((snap) => {
                    if(!snap.exists) { alert("Room Reset."); location.reload(); return; }
                    const d = snap.data();
                    localData = d;
                    
                    // Ensure I exist
                    if(!d.players.find(p => p.id === myId)) {
                         alert("Disconnected."); location.reload(); return; 
                    }

                    // Render
                    if(isHost) renderAdmin(d);
                    renderLobby(d);
                    renderGame(d);

                    // Auto-nav for students
                    if(!isHost) {
                        if(d.status === 'playing') switchScene('game');
                        else switchScene('lobby');
                    }
                    
                    document.getElementById('connectionStatus').textContent = "Online";
                });
            }).catch(e => log("JOIN ERROR: " + e.message));
        }

        function forceResetRoom() {
            if(!confirm("Reset Room? (Kicks all)")) return;
            const me = { id: myId, name: myName, score: 0, isSpectator: true };
            db.collection('rooms').doc(myRoom).set({
                status: 'lobby', players: [me], hostId: myId,
                cards: [], setupComplete: false, turnIndex: 0, flipped: []
            }).then(() => {
                log("Reset Done");
                if(isHost) switchScene('admin');
            });
        }

        function saveGameSettings() {
            const txt = document.getElementById('gameWordsInput').value;
            const part = document.getElementById('hostParticipates').checked;
            
            // Parse Cards
            let cards = [];
            let pid = 0;
            txt.trim().split('\n').forEach(line => {
                let [en, jp] = line.split('\t');
                if(!jp && line.includes(',')) [en, jp] = line.split(',');
                if(en && jp) {
                    cards.push({id:0, pairId:pid, text:en.trim(), type:'en', isFlipped:false, isMatched:false});
                    cards.push({id:0, pairId:pid, text:jp.trim(), type:'jp', isFlipped:false, isMatched:false});
                    pid++;
                }
            });
            if(cards.length < 4) { alert("Need 2+ pairs"); return; }
            
            // Shuffle
            for(let i=cards.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            cards.forEach((c,i) => c.id=i);

            // Update
            const newP = localData.players.map(p => p.id === myId ? {...p, isSpectator: !part} : p);
            
            db.collection('rooms').doc(myRoom).update({
                cards: cards, setupComplete: true, players: newP
            }).then(() => alert("Ready!"));
        }

        function startGame() {
            let first = 0;
            while(localData.players[first].isSpectator && first < localData.players.length) first++;
            db.collection('rooms').doc(myRoom).update({
                status: 'playing', turnIndex: first, flipped: []
            });
        }

        function handleCardClick(idx) {
            if(!localData) return;
            const p = localData.players[localData.turnIndex];
            if(p.id !== myId) return;
            if(localData.flipped.length >= 2) return;
            if(localData.cards[idx].isFlipped || localData.cards[idx].isMatched) return;

            const newCards = [...localData.cards];
            newCards[idx].isFlipped = true;
            const newFlipped = [...localData.flipped, idx];

            db.collection('rooms').doc(myRoom).update({
                cards: newCards, flipped: newFlipped
            });

            if(newFlipped.length === 2) {
                setTimeout(() => checkMatch(newCards, newFlipped), 1500);
            }
        }

        function checkMatch(cards, flipped) {
            const c1 = cards[flipped[0]];
            const c2 = cards[flipped[1]];
            let up = {};

            if(c1.pairId === c2.pairId) {
                cards[flipped[0]].isMatched = true;
                cards[flipped[1]].isMatched = true;
                const ps = [...localData.players];
                ps[localData.turnIndex].score++;
                up = { cards: cards, players: ps, flipped: [] };
            } else {
                cards[flipped[0]].isFlipped = false;
                cards[flipped[1]].isFlipped = false;
                let next = (localData.turnIndex + 1) % localData.players.length;
                let loop = 0;
                while(localData.players[next].isSpectator && loop < localData.players.length) {
                    next = (next + 1) % localData.players.length; loop++;
                }
                up = { cards: cards, turnIndex: next, flipped: [] };
            }
            db.collection('rooms').doc(myRoom).update(up);
        }

        // --- RENDERERS ---
        function renderAdmin(d) {
            const list = document.getElementById('adminPlayerList');
            list.innerHTML = d.players.map(p => 
                `<div class="flex justify-between p-2 border-b"><span>${p.name} ${p.isSpectator?'(Spec)':''}</span><span>${p.score}pt</span></div>`
            ).join('');
        }
        function renderLobby(d) {
            document.getElementById('lobbyPlayerList').innerHTML = d.players.map(p => 
                `<div class="bg-gray-100 p-2 rounded text-center">${p.name}</div>`
            ).join('');
            if(d.setupComplete) {
                document.getElementById('commonStartArea').classList.remove('hidden');
                document.getElementById('waitingMessage').classList.add('hidden');
            } else {
                document.getElementById('commonStartArea').classList.add('hidden');
                document.getElementById('waitingMessage').classList.remove('hidden');
            }
        }
        function renderGame(d) {
            const p = d.players[d.turnIndex];
            if(p) {
                const ind = document.getElementById('gameTurnIndicator');
                ind.textContent = p.name + (p.id===myId ? " (YOU)" : "");
                ind.className = (p.id===myId) ? "text-xl font-bold p-2 rounded bg-green-100 text-green-700 border-2 border-red-500" : "text-xl font-bold p-2 rounded bg-blue-50 text-blue-600";
            }
            document.getElementById('gameScoreBoard').innerHTML = d.players.map((pp,i) => 
                !pp.isSpectator ? `<div class="flex justify-between p-2 ${i===d.turnIndex?'bg-blue-100':''}"><span>${pp.name}</span><span>${pp.score}</span></div>` : ''
            ).join('');
            
            document.getElementById('gameGrid').innerHTML = d.cards.map((c,i) => `
                <div class="card-container ${c.isFlipped?'flipped':''} ${c.isMatched?'matched-visible':''}" onclick="handleCardClick(${i})">
                    <div class="card-inner bg-white">
                        <div class="card-front text-2xl font-bold text-white">${i+1}</div>
                        <div class="card-back flex items-center justify-center p-2 text-center text-sm font-bold">${c.text}</div>
                    </div>
                </div>
            `).join('');
        }

        // Defaults
        document.getElementById('gameWordsInput').value = defaultWords;
        if(localStorage.getItem('pname')) document.getElementById('playerName').value = localStorage.getItem('pname');
        if(localStorage.getItem('proom')) document.getElementById('roomName').value = localStorage.getItem('proom');
        lucide.createIcons();
    </script>
</body>
</html>
